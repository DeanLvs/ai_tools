<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bookyes</title>
    <!-- Fancybox CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0.0/dist/fancybox.min.css" />

    <!-- Fancybox JS -->
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0.0/dist/fancybox.umd.js"></script>
    <style>
        /* é¡µé¢æ•´ä½“å¸ƒå±€ */
        body {
            display: flex;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        /* å·¦ä¾§å›¾ç‰‡åˆ—è¡¨åŒºåŸŸ */
        .left-panel {
            flex: 1;
            max-width: calc(100% - 320px); /* ä¿ç•™å³ä¾§æ“ä½œåŒºç©ºé—´ï¼Œè®¾ç½®åˆç†å®½åº¦ */
            overflow-y: auto;
            padding: 20px;
            background-color: #f1f1f1;
            display: flex;
            flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
            gap: 10px; /* å›¾ç‰‡é—´è· */
            box-sizing: border-box;
            margin-right: 20px; /* ä¸å³ä¾§æ“ä½œåŒºçš„é—´è· */
        }

        /* å›ºå®šå³ä¾§æ“ä½œåŒºåŸŸ */
        .right-panel {
            width: 300px;
            background-color: #f9f9f9;
            padding: 20px;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 2;
            pointer-events: auto;
        }


        /* è¿›åº¦æ¡å®¹å™¨ */
        .progress-container {
            margin-top: 20px;
            height: 35px;
            background-color: #ddd;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar {
            width: 0;
            height: 100%;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            transition: width 0.3s ease;
            line-height: 35px; /* å‚ç›´å±…ä¸­å¯¹é½ */
        }

        .progress-description {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%); /* å±…ä¸­å¯¹é½ */
            font-size: 14px;
            color: #333;
            z-index: 1;
            pointer-events: none; /* é˜²æ­¢æ–‡å­—é˜»æŒ¡è¿›åº¦æ¡ç‚¹å‡» */
        }

        /* åœ¨çº¿ç”¨æˆ·æ•°æ˜¾ç¤º */
        .online-users {
            margin-top: 20px;
            color: #333;
            font-size: 16px;
        }

        /* å›¾ç‰‡å±•ç¤ºå®¹å™¨ */
        .image-container {
            position: relative;
            width: 200px; /* å›ºå®šå›¾ç‰‡æ¡†çš„å®½åº¦ */
            height: 200px; /* å›ºå®šå›¾ç‰‡æ¡†çš„é«˜åº¦ */
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .image-container img, .image-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        /* æ‚¬æµ®é€‰æ‹©æŒ‰é’®å’Œæ ‡é¢˜ */
        .image-overlay {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }

        .select-button {
            font-size: 14px;
            color: white;
            background-color: #ccc;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .target-button {
            font-size: 14px;
            color: red;
            background-color: #ffcc00;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .source-button{
            font-size: 14px;
            color: black;
            background-color: #ffcc00;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .source-selected {
            background-color: #ffcc00;
        }

        /* æ§åˆ¶åŒºä¸ŠåŠéƒ¨åˆ† */
        .controls-container {
            flex: 1; /* å æ®ä¸ŠåŠéƒ¨åˆ†ç©ºé—´ */
            margin-bottom: 20px; /* ç»™ä¸‹æ–¹èŠå¤©å®¹å™¨ç•™ç©ºé—´ */
        }

        /* èŠå¤©å®¹å™¨ä¸‹åŠéƒ¨åˆ† */
        .chat-container {
            flex: 1; /* å æ®å‰©ä½™çš„ä¸‹åŠéƒ¨åˆ†ç©ºé—´ */
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background-color: #f9f9f9;
        }
        .chat-box {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .chat-message {
            background-color: #ffcc00;
            color: black;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
            align-self: flex-start;
        }
        .chat-message.user {
            background-color: #4CAF50;
            align-self: flex-end;
        }

        /* èŠå¤©è¾“å…¥æ¡† */
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
            background-color: #ffffff;
        }
        .chat-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-right: 10px;
        }



        /* Pair list styling */
        .pair-list {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f1f1f1;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }
        .pair-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }
        .thumbnail {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            object-fit: cover;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
        }
        .arrow {
            font-size: 18px;
            color: #555;
        }

        h4 {
            font-size: 20px; /* æ›´å°çš„å­—ä½“ */
            line-height: 1;  /* å‡å°‘è¡Œé«˜ */
            margin: 2px 0;   /* è°ƒæ•´é¡¶éƒ¨å’Œåº•éƒ¨çš„ margin */
            padding: 0;      /* å»é™¤ padding */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* åˆå§‹çŠ¶æ€éšè— */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background-color: #fff;
            padding: 20px;
            width: 400px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .modal textarea {
            width: 100%;
            height: 200px;
            resize: none;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        .button, .modal button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #6cb2eb, #4a90e2);
            color: #ffffff;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            margin-bottom: 2px;
        }

        .button:active, .modal button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #4a90e2, #6cb2eb);
        }

        /* çˆ¶å®¹å™¨çš„æ ·å¼ï¼Œä½¿ç”¨flexå¸ƒå±€å’Œå‚ç›´æ–¹å‘æ’åˆ— */
        .controls-container {
            display: flex;
            flex-direction: column;
            gap: 1px; /* æ§åˆ¶æŒ‰é’®é—´è· */
        }

        /* ä¸Šä¼ åŒºåŸŸå’ŒæŒ‰é’®æ•´ä½“æ ·å¼ */
        .upload-section {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            width: 100%;
        }

        /* æŒ‰é’®æ ·å¼ */
        .upload-section .small-button, .upload-section .file-upload-button {
            flex: 1 1 calc(50% - 10px); /* æ¯ä¸ªæŒ‰é’®å 50%çš„å®½åº¦ï¼Œå¹¶åŒ…å«é—´è· */
            padding: 8px 12px;
            font-size: 14px;
            text-align: center;
            color: white;
            border: none;
            border-radius: 4px;
            background: linear-gradient(135deg, #6cb2eb, #4a90e2);
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            transition: background 0.3s ease, transform 0.2s ease;
        }

        /* ä¸Šä¼ æŒ‰é’®æ ·å¼ï¼Œéšè—å®é™…æ–‡ä»¶è¾“å…¥æ¡† */
        .upload-section .file-upload-button input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* æ‚¬æµ®å’Œç‚¹å‡»æ•ˆæœ */
        .upload-section .small-button, .upload-section .file-upload-button {
            background: linear-gradient(135deg, #5ba4d8, #3b81c2);
            transform: translateY(-2px);
        }

        .upload-section .small-button:active, .upload-section .file-upload-button:active {
            transform: translateY(1px);
            background: linear-gradient(135deg, #4a90e2, #6cb2eb);
        }

        /* åŠé€æ˜é®ç½©å±‚æ ·å¼ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        /* é®ç½©å±‚å†…å®¹æ ·å¼ */
        .overlay-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .overlay-content p {
            margin: 0 0 15px;
            font-size: 18px;
            color: #333;
        }

        /* é®ç½©å±‚æŒ‰é’®æ ·å¼ */
        .overlay-content button {
            padding: 8px 16px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
    </style>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        let socket = io();
        let sourceImage = null;
        let org_faces_name = []
        let to_faces_name = []
        // ç”¨äºè®°å½•å·²å¤„ç†çš„æ–‡ä»¶å
        const processedFiles = new Set();
        let room_id = checkUUID();
        let rev_pre = false;
        checkSocket();
        /**
         * å‘ chatBox ä¸­æ·»åŠ ä¸€æ¡æ¶ˆæ¯
         * @param {string} message - è¦æ˜¾ç¤ºçš„æ¶ˆæ¯æ–‡æœ¬
         * @param {string} sender - æ¶ˆæ¯çš„å‘é€è€…ç±»å‹ ('user' æˆ– 'server')
         */
        function addChatMessage(topic, message, sender) {
            console.log('receive message:', topic, message);
            const chatBox = document.getElementById('chatBox');

            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', sender === 'user' ? 'user' : 'server');
            messageDiv.textContent = message;

            // å°†æ¶ˆæ¯å…ƒç´ æ·»åŠ åˆ° chatBox ä¸­
            chatBox.appendChild(messageDiv);

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function resetSel(){
            const allButtons = document.querySelectorAll('.select-button');
            allButtons.forEach(btn => {
                btn.style.backgroundColor = '#ccc';
                btn.innerText = 'é€‰æ‹©';
            });
            document.getElementById('filename').value = '';
        }

        /**
         * Reset all unpaired buttons to their default "é€‰æ‹©" state.
         */
        function resetAllButtons() {
            document.querySelectorAll('.source-button').forEach((btn) => {
                btn.classList.add('target-button');
                btn.classList.remove('source-button');
                btn.innerText = 'ç›®æ ‡è„¸';
            });
        }

        function resetAllButtonsToSource() {
            document.querySelectorAll('.target-button').forEach((btn) => {
                btn.classList.add('source-button');
                btn.classList.remove('target-button');
                btn.innerText = 'æºè„¸';
            });
            document.querySelectorAll('.source-selected').forEach((btn) => {
                btn.classList.add('source-button');
                btn.classList.remove('source-selected');
                btn.innerText = 'æºè„¸';
            });
        }

        function handleSourceTargetSelection(imgSrc, button) {
            const fileName = imgSrc.split('/').pop();
            // Select source image
            if (button.classList.contains('source-button')) {
                button.classList.remove('source-button');
                button.classList.add('source-selected');
                button.innerText = 'å½“å‰æºè„¸';
                sourceImage=imgSrc;
                resetAllButtons();
            } else if (button.classList.contains('target-button')) {
                const pairList = document.getElementById('pairList');
                pairList.style.display = 'block';

                // åŠ¨æ€æ·»åŠ æŒ‰é’®
                const clearButton = document.createElement('button');
                clearButton.id = 'pairList-button';
                clearButton.className = 'clear-button';
                clearButton.innerText = 'æ¸…ç©ºé…å¯¹';
                clearButton.onclick = clearPairs;
                pairList.appendChild(clearButton);

                addPairToList(sourceImage, imgSrc);
                source_face_name = sourceImage.split('/').pop();
                org_faces_name.push(source_face_name);
                to_faces_name.push(fileName);
                sourceImage = null;
                resetAllButtonsToSource();
            }
        }

        function isVideoFile(filename) {
            // å®šä¹‰è§†é¢‘æ–‡ä»¶æ‰©å±•åçš„æ•°ç»„
            const videoExtensions = ['.mp4', '.mov', '.avi', '.mkv', '.flv', '.wmv', '.webm'];

            // è·å–æ–‡ä»¶æ‰©å±•åå¹¶è½¬ä¸ºå°å†™
            const fileExtension = filename.slice(filename.lastIndexOf('.')).toLowerCase();

            // åˆ¤æ–­æ–‡ä»¶æ‰©å±•åæ˜¯å¦åœ¨è§†é¢‘æ‰©å±•ååˆ—è¡¨ä¸­
            return videoExtensions.includes(fileExtension);
        }

        function handleSelectClick(imgSrc, button) {
            const fileName = imgSrc.split('/').pop();
            const currentBgColor = button.style.backgroundColor;
            if (currentBgColor === 'blue') {
                // å°†æŒ‰é’®æ¢å¤ä¸ºæœªé€‰æ‹©çŠ¶æ€
                button.style.backgroundColor = '#ccc';
                button.innerText = 'é€‰æ‹©';
                document.getElementById('filename').value = '';
                return;
            }
            resetSel();
            button.style.backgroundColor = 'blue';
            button.innerText = 'å–æ¶ˆ';
            document.getElementById('filename').value = fileName;
        }
        function add_img_to_list(url_path, specialImageListDiv, p_name, in_img_type) {
            console.log(url_path);
            const container = document.createElement('div');
            container.classList.add('image-container');

            const ext = url_path.split('.').pop().toLowerCase();
            const captionText = p_name || "å¤„ç†ç»“æœ";

            // åˆ¤æ–­æ˜¯å¦æ˜¯éŸ³é¢‘
            if (['mp3', 'wav', 'm4a', 'flac', 'aac'].includes(ext)) {
                const audio = document.createElement('audio');
                audio.src = url_path;
                audio.controls = true;
                audio.style.width = '100%';
                container.appendChild(audio);

                const caption = document.createElement('div');
                caption.style.textAlign = 'center';
                caption.style.fontSize = '14px';
                caption.style.marginTop = '5px';
                caption.innerText = captionText;
                container.appendChild(caption);

                specialImageListDiv.appendChild(container);
                return;
            }

            // åˆ¤æ–­æ˜¯å¦æ˜¯è§†é¢‘
            if (['mp4', 'mov', 'avi', 'mkv', 'webm'].includes(ext)) {
                const link = document.createElement('a');
                link.href = url_path;
                link.setAttribute('data-fancybox', 'gallery');
                link.setAttribute('data-caption', captionText);

                const video = document.createElement('video');
                video.src = url_path;
                video.controls = true;
                video.style.width = '100%';
                video.alt = 'å¤„ç†åçš„è§†é¢‘';
                link.appendChild(video);
                container.appendChild(link);

                const overlay = document.createElement('div');
                overlay.classList.add('image-overlay');
                const caption = document.createElement('span');
                caption.innerText = captionText;
                overlay.appendChild(caption);

                const selectButton = document.createElement('button');
                selectButton.innerText = 'é€‰æ‹©';
                selectButton.classList.add('select-button');
                selectButton.onclick = () => handleSelectClick(link.href, selectButton);
                overlay.appendChild(selectButton);

                container.appendChild(overlay);
                specialImageListDiv.appendChild(container);
                return;
            }

            // é»˜è®¤å½“ä½œå›¾ç‰‡å¤„ç†
            const link = document.createElement('a');
            link.href = url_path;
            link.setAttribute('data-fancybox', 'gallery');
            link.setAttribute('data-caption', captionText);

            const img = document.createElement('img');
            img.src = url_path;
            img.alt = 'å¤„ç†åçš„å›¾ç‰‡';
            link.appendChild(img);
            container.appendChild(link);

            const overlay = document.createElement('div');
            overlay.classList.add('image-overlay');

            const caption = document.createElement('span');
            caption.innerText = captionText;
            overlay.appendChild(caption);

            const selectButton = document.createElement('button');
            selectButton.innerText = 'é€‰æ‹©';
            selectButton.classList.add('select-button');
            selectButton.onclick = () => handleSelectClick(link.href, selectButton);

            if (in_img_type === 'face_pre') {
                const selectFaceButton = document.createElement('button');
                selectFaceButton.innerText = 'æºè„¸';
                selectFaceButton.classList.add('source-button');
                selectFaceButton.onclick = () => handleSourceTargetSelection(link.href, selectFaceButton);
                overlay.appendChild(selectFaceButton);
            }

            overlay.appendChild(selectButton);
            container.appendChild(overlay);
            specialImageListDiv.appendChild(container);
        }
        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function setupSocketListeners(socket, room_id) {
            socket.on('connect', () => {
                const session_id = socket.id;
                console.log('Connected with session ID:', session_id);
                socket.emit('join_room', { roomId: room_id });
            });
            socket.on('disconnect', () => {
                room_id = checkUUID();
                console.log('Socket disconnected. Attempting to reconnect...');
                reconnectSocket(room_id);
            });
            socket.on('processing_step_progress', (data) => {
                addChatMessage('processing_step_progress', data.text, 'server');
            });

            socket.on('processing_progress', (data) => {
                const progressBar = document.querySelector('.progress-bar');
                progressBar.style.width = `${data.progress}%`;
                progressBar.innerText = `${data.progress}%`;
                if (data.had) {
                    progressBar.innerText = progressBar.innerText + ' ' + data.had
                }
            });

            socket.on('processing_done_text', (data) => {
                addChatMessage('processing_done_text', data.text, 'server');
            });

            // ç›‘å¬æœåŠ¡å™¨å‘é€çš„ 'online_users' äº‹ä»¶
            socket.on('online_users', (data) => {
                const onlineUsersElement = document.getElementById('onlineUsers');
                onlineUsersElement.innerText = `æ¶ˆæ¯é€šçŸ¥ åœ¨çº¿äººæ•°: ${data.count}`;
            });

            socket.on('processing_done', (data) => {
                if(!data.processed_image_url){
                     console.warn('processed_image_url is undefined or invalid');
                     return;
                }
                const imageListDiv = document.getElementById('imageList');
                if (!data.processed_image_url.startsWith('/uploads')) {
                    data.processed_image_url = '/uploads' + '/' + room_id + '/' + data.processed_image_url;
                }
                // è·å–æ–‡ä»¶åï¼Œç”¨äºæŸ¥æ‰¾é‡å¤çš„å…ƒç´ 
                const newFileName = data.processed_image_url.split('/').pop();
                // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¯¥æ–‡ä»¶å
                if (processedFiles.has(newFileName)) {
                    // å¦‚æœæ–‡ä»¶åå·²å¤„ç†è¿‡ï¼Œç›´æ¥è·³è¿‡
                    console.log(`æ–‡ä»¶ ${newFileName} å·²å¤„ç†ï¼Œè·³è¿‡é‡å¤å¤„ç†`);
                    return;
                }
                // æ·»åŠ æ–‡ä»¶ååˆ°é›†åˆï¼Œæ ‡è®°ä¸ºå·²å¤„ç†
                processedFiles.add(newFileName);

                // åˆ é™¤å·²æœ‰ç›¸åŒæ–‡ä»¶åçš„å›¾ç‰‡ / è§†é¢‘ / éŸ³é¢‘å…ƒç´ 
                const existingMedia = imageListDiv.querySelectorAll('img, video, audio');
                existingMedia.forEach(media => {
                    const srcPath = new URL(media.src).pathname;
                    const existingFileName = srcPath.split('/').pop();
                    if (existingFileName === newFileName) {
                        media.parentElement.remove();
                    }
                });
                lowerUrl = 'xxx';
                if (data.processed_image_url) {
                   lowerUrl = data.processed_image_url.toLowerCase();
                }
                if (lowerUrl.endsWith('.mp4')) {
                    // å¦‚æœæ˜¯ mp4 ç»“å°¾çš„è§†é¢‘ï¼Œå¼ºåˆ¶ä½œä¸º video ç±»å‹å¤„ç†
                    add_img_to_list(data.processed_image_url, imageListDiv, data.name, 'video');
                } else if(data.img_type == 'done' || data.img_type == 'face_pre'){
                    add_img_to_list(data.processed_image_url, imageListDiv, data.name, data.img_type);
                } else if (data.img_type === 'video' || data.img_type === 'audio') {
                    // ç»Ÿä¸€å¤„ç†ï¼šå…¨éƒ¨äº¤ç»™ add_img_to_list æ¸²æŸ“
                    add_img_to_list(data.processed_image_url, imageListDiv, data.name, data.img_type);
                }  else if(rev_pre){
                    add_img_to_list(data.processed_image_url, imageListDiv, data.name, data.img_type);
                }
                const progressBar = document.querySelector('.progress-bar');
                progressBar.style.width = '0%';
                progressBar.innerText = '';
                if (!data.keephide) {
                }
            });
        }

        function addPairToList(sourceImg, targetImg) {
            const pairList = document.getElementById('pairList');
            const pairItem = document.createElement('div');
            pairItem.className = 'pair-item';

            // Source image thumbnail
            const sourceThumbnail = document.createElement('img');
            sourceThumbnail.src = sourceImg;
            sourceThumbnail.className = 'thumbnail';

            // Target image thumbnail
            const targetThumbnail = document.createElement('img');
            targetThumbnail.src = targetImg;
            targetThumbnail.className = 'thumbnail';

            // Arrow element
            const arrow = document.createElement('span');
            arrow.className = 'arrow';
            arrow.textContent = 'â†’';

            // Add items to pairItem div
            pairItem.appendChild(sourceThumbnail);
            pairItem.appendChild(arrow);
            pairItem.appendChild(targetThumbnail);
            pairList.appendChild(pairItem);
        }

        function processImage_inpaint_b() {
            const filename = document.getElementById('filename').value;
            if (!filename || filename.trim() === '') {
                alert('å…ˆé€‰æ‹©ä¸€ä¸ªè¦å¤„ç†çš„å›¾å§');
                // è¿™é‡Œå¯ä»¥æ·»åŠ å…¶ä»–å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚é˜»æ­¢è¡¨å•æäº¤ç­‰
                return;
            }
            if(isVideoFile(filename)){
                alert('ç®—åŠ›ç´§å¼ ï¼Œè§†é¢‘å¤„ç†è¯·ç­‰å¾…ä½å³°æœŸå†æäº¤');
                return;
            }
            showOverlay();
            const room_id = checkUUID();
            checkSocket();
            socket.emit('process_image_inpaint', { filename, roomId: room_id });
        }

        function check_face_b() {
            const filename = document.getElementById('filename').value;
            if (!filename || filename.trim() === '') {
                alert('å…ˆé€‰æ‹©ä¸€ä¸ªè¦å¤„ç†çš„å›¾å§');
                // è¿™é‡Œå¯ä»¥æ·»åŠ å…¶ä»–å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚é˜»æ­¢è¡¨å•æäº¤ç­‰
                return;
            }
            if(isVideoFile(filename)){
                alert('ç®—åŠ›ç´§å¼ ï¼Œè§†é¢‘å¤„ç†è¯·ç­‰å¾…ä½å³°æœŸå†æäº¤');
                return;
            }
            showOverlay();
            const room_id = checkUUID();
            checkSocket();
            pre_face_pic_list = [filename]
            socket.emit('process_pic_find_face', { filename, pre_face_pic_list, roomId: room_id});
        }

        function swap_face_b() {
            const filename = document.getElementById('filename').value;
            if (!filename || filename.trim() === '') {
                alert('å…ˆåˆ†åˆ«ä¸Šä¼ éœ€è¦æ›¿æ¢çš„ä¸¤å¼ äººç‰©å›¾ï¼Œä¾æ¬¡åˆ†åˆ« é€‰æ‹© å ç‚¹å‡»[é¢éƒ¨ç‰¹å¾æå–]åä¼šæå–åˆ°è„¸å›¾ åœ¨é€‰æ‹© æºè„¸ å’Œ ç›®æ ‡è„¸ é…å¯¹ å é€‰æ‹©è¦æ¢çš„å›¾åœ¨æ¥ç‚¹å‡»æ¢è„¸å“ˆ');
                // è¿™é‡Œå¯ä»¥æ·»åŠ å…¶ä»–å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚é˜»æ­¢è¡¨å•æäº¤ç­‰
                return;
            }
            if (org_faces_name.length <= 0 || to_faces_name.length <= 0 || org_faces_name.length !== to_faces_name.length) {
                alert('å…ˆåˆ†åˆ«ä¸Šä¼ éœ€è¦æ›¿æ¢çš„ä¸¤å¼ äººç‰©å›¾ï¼Œä¾æ¬¡åˆ†åˆ« é€‰æ‹© å ç‚¹å‡»[é¢éƒ¨ç‰¹å¾æå–]åä¼šæå–åˆ°è„¸å›¾ åœ¨é€‰æ‹© æºè„¸ å’Œ ç›®æ ‡è„¸ é…å¯¹ å é€‰æ‹©è¦æ¢çš„å›¾åœ¨æ¥ç‚¹å‡»æ¢è„¸å“ˆ');
                return;
            }
            topic = 'process_pic_swap_face';
            if(isVideoFile(filename)){
                topic = 'process_video_swap_face';
            }
            showOverlay();
            console.log('swap info', to_faces_name, org_faces_name, filename);
            const room_id = checkUUID();
            checkSocket();
            pre_face_pic_list = [filename]
            socket.emit(topic, { filename, org_faces: org_faces_name, to_faces: to_faces_name, roomId: room_id});
        }

        function checkSocket(){
            if (!socket || !socket.connected) {
                console.log('Attempting to reconnect...');
                initializeSocket(room_id);
            }
        }

        function reconnectSocket(room_id) {
            if (!socket || !socket.connected) {
                console.log('Attempting to reconnect...');
                initializeSocket(room_id);
            }
            socket.emit('re_get', { roomId:room_id });
        }

        function initializeSocket(room_id) {
            if (socket) {
                socket.disconnect(); // æ–­å¼€ç°æœ‰çš„ socket è¿æ¥
            }
            socket = io();
            setupSocketListeners(socket, room_id);
        }

        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days*24*60*60*1000));
            const expires = "expires="+ d.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i=0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(nameEQ) === 0) {
                    return c.substring(nameEQ.length, c.length);
                }
            }
            return null;
        }

        function checkUUID() {
            let uuid = getCookie("uuid");
            if (uuid === null) {
                uuid = uuidv4();
                setCookie("uuid", uuid, 365); // å­˜å‚¨ä¸€å¹´
            }
            return uuid;
        }
        function viewImage() {
            const room_id = checkUUID();
            resetSel();
            reconnectSocket(room_id);
        }
        function clearPairs() {
            document.getElementById('pairList').innerHTML = '';
            org_faces_name = []
            to_faces_name = []
            document.getElementById('pairList').style.display = 'none';
        }

        function showModal() {
            const filename = document.getElementById('filename').value;
            if (!filename || filename.trim() === '') {
                alert('å…ˆé€‰æ‹©ä¸€ä¸ªè¦å¤„ç†çš„å›¾å§');
                // è¿™é‡Œå¯ä»¥æ·»åŠ å…¶ä»–å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚é˜»æ­¢è¡¨å•æäº¤ç­‰
                return;
            }
            if(isVideoFile(filename)){
                alert('ç®—åŠ›ç´§å¼ ï¼Œè§†é¢‘å¤„ç†è¯·ç­‰å¾…ä½å³°æœŸå†æäº¤');
                return;
            }
            const modalOverlay = document.getElementById('modalOverlay');
            loadButtons();
            modalOverlay.style.display = 'flex';
        }

        function closeModal() {
            const modalOverlay = document.getElementById('modalOverlay');
            modalOverlay.style.display = 'none';
        }

        function confirmSocre() {
            const room_id = checkUUID();
            checkSocket();
            const secKey = document.getElementById('secKeyInput').value;
            socket.emit('add_core', { secKey, roomId: room_id});
            closeComOverlay();
        }

        function confirmInput() {
            const userInput = document.getElementById('modalTextarea').value;
            console.log("User input:", userInput);
            if (userInput === "") {
                alert("è¯·è¾“å…¥å†…å®¹ï¼");
                return;
            }
            showOverlay();
            const room_id = checkUUID();
            prompt = userInput
            reverse_prompt = ''
            const filename = document.getElementById('filename').value;
            gen_type = ''
            checkSocket();
            face_filename=''
            socket.emit('process_text_gen_pic', { filename, face_filename, prompt, reverse_prompt, gen_type, roomId: room_id});
            closeModal();
        }

        function confirmInputFlux() {
            const userInput = document.getElementById('modalTextarea').value;
            console.log("User input:", userInput);
            if (userInput === "") {
                alert("è¯·è¾“å…¥å†…å®¹ï¼");
                return;
            }
            showOverlay();
            const room_id = checkUUID();
            prompt = userInput
            reverse_prompt = ''
            const filename = document.getElementById('filename').value;
            gen_type = 'flux'
            checkSocket();
            face_filename=''
            socket.emit('process_text_gen_pic', { filename, face_filename, prompt, reverse_prompt, gen_type, roomId: room_id});
            closeModal();
        }

        function showOverlay() {
            document.getElementById('overlay').style.display = 'flex';
        }

        function closeOverlay() {
            document.getElementById('overlay').style.display = 'none';
        }

        function showComOverlay() {
            document.getElementById('overlayInput').style.display = 'flex';
        }

        function closeComOverlay() {
            document.getElementById('overlayInput').style.display = 'none';
        }

        // è·å–å¹¶å¡«å……æŒ‰é’®
        function loadButtons() {
            fetch('/api/getkeys', { method: 'GET' })
                .then(response => response.json())
                .then(keys => {
                    const configPrompt = document.getElementById('config_prompt');
                    configPrompt.innerHTML = ''
                    const poDiv = document.createElement('div');
                    poDiv.textContent = 'å¿«æ·åœºæ™¯ï¼Œç‚¹å®Œç›´æ¥ å¼€å§‹ç”Ÿæˆå³å¯';
                    configPrompt.appendChild(poDiv);
                    keys.forEach(key => {
                        // åˆ›å»ºæŒ‰é’®å¹¶è®¾ç½®äº‹ä»¶
                        const button = document.createElement('button');
                        button.textContent = key;
                        button.onclick = () => changeText(key);
                        configPrompt.appendChild(button);
                    });

                })
                .catch(error => console.error('Error:', error));
        }

        // æ›´æ”¹æ–‡æœ¬å†…å®¹çš„å‡½æ•°
        function changeText(key) {
            console.log('Clicked button with key:', key);
            document.getElementById('modalTextarea').value=key;
            // å¤„ç†ç‚¹å‡»åçš„é€»è¾‘ï¼Œä¾‹å¦‚å°†keyçš„å€¼å±•ç¤ºåœ¨æŸä¸ªåœ°æ–¹
        }

    </script> <!-- è®°å¾—æ›¿æ¢æˆä½ çš„JSæ–‡ä»¶è·¯å¾„ -->
</head>
<body>
    <!-- å·¦ä¾§å›¾ç‰‡åˆ—è¡¨åŒºåŸŸ -->
    <div class="left-panel" id="imageList">
        <!-- åŠ¨æ€æ·»åŠ ç”Ÿæˆçš„å›¾ç‰‡ -->
    </div>

    <!-- å³ä¾§æ“ä½œåŒºåŸŸ -->
    <div class="right-panel">
        <div class="controls-container">
            <h4>BOOK YES PCé¡µé¢</h4>
            <h4>[ä»…ä¾›å­¦æœ¯ç ”ç©¶ä½¿ç”¨]</h4>
            <div class="upload-section">
                <label class="file-upload-button">
                    ä¸Šä¼ å›¾ç‰‡\è§†é¢‘\éŸ³é¢‘
                    <input type="file" id="fileInput" accept="image/*,video/*,audio/*" onchange="uploadImage()" />
                </label>
                <button class="small-button" onclick="processImage_inpaint_b()">æ¢è£…</button>
                <button class="small-button" onclick="showModal()">æ¢åœºæ™¯(èµ„æºä¸è¶³ã€æš‚ä¸æ”¯æŒ)</button>
                <button class="small-button" onclick="check_face_b()">é¢éƒ¨ç‰¹å¾æå–â†’</button>
                <button class="small-button" onclick="swap_face_b()">â†’æ¢è„¸</button>
                <button class="small-button" onclick="viewImage()">æŸ¥çœ‹å†å²</button>
                <button class="small-button" onclick="showComOverlay()">ç§¯åˆ†å…‘æ¢</button>
                <button class="small-button" onclick="toggleRecording(this)">ğŸ™ï¸ å½•éŸ³</button>

            </div>
            <input type="hidden" id="filename">
            <div class="progress-container">
                <p class="progress-description">è¿™æ˜¯[è¿›åº¦æ¡]</p>
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            <!-- List of selected pairs -->
            <div class="pair-list" id="pairList">
            </div>

        </div>

        <div class="chat-container">
            <div class="chat-box" id="chatBox">
                <!-- WebSocket æ¥æ”¶çš„æ¶ˆæ¯å°†ä¼šè¢«åŠ¨æ€æ’å…¥åœ¨æ­¤ -->
            </div>
            <div id="onlineUsers" class="online-users">åœ¨çº¿äººæ•°: 0</div>
        </div>
    </div>
    <div id="modalOverlay" class="modal-overlay">
    <div class="modal">
        <div class="modal" id="config_prompt">
        </div>
        <textarea id="modalTextarea" placeholder="é€‰æ‹©çš„å›¾ç‰‡æœ‰å¤šä¸ªäººæ—¶ï¼Œä¼šéšæœºé€‰æ‹©ç”Ÿæˆï¼Œå¯ä»¥å…ˆç‚¹å‡»[é¢éƒ¨ç‰¹å¾æå–]åé€‰æ‹©ç”Ÿæˆçš„è„¸éƒ¨å›¾ç‰‡ï¼Œå†[æ¢åœºæ™¯], ä½ å¯ä»¥åœ¨è¿™é‡Œè¾“å…¥æƒ³è¦çš„åœºæ™¯å†…å®¹..."></textarea>
        <button onclick="confirmInput()">ä½¿ç”¨1.0ç‰ˆæœ¬(ç”Ÿæˆ6å¼ å›¾)</button>
        <button onclick="confirmInputFlux()">ä½¿ç”¨1.2ç‰ˆæœ¬(ç”Ÿæˆ1å›¾)</button>
        <button onclick="closeModal()">å–æ¶ˆ</button>
    </div>
</div>

    <div class="overlay" id="overlay">
        <div class="overlay-content">
            <p>æ­£åœ¨æ‰§è¡Œ...è¯·ç¨å€™...æ³¨æ„å³ä¾§ å¤„ç†[è¿›åº¦æ¡] ä»¥åŠ æ¶ˆæ¯é€šçŸ¥</p>
            <button onclick="closeOverlay()">ç¡®å®š</button>
        </div>
    </div>

    <div class="overlay" id="overlayInput">
        <div class="overlay-content">
            <textarea id="secKeyInput" placeholder="è¾“å…¥å…‘æ¢ç "></textarea>
            <button onclick="closeComOverlay()">å–æ¶ˆ</button>
            <button onclick="confirmSocre()">ç¡®å®š</button>
        </div>
    </div>
<script>
        function uploadImage() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            room_id = checkUUID();
            formData.append('room_id', room_id);
            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>

    <script>
    let mediaRecorder = null;
    let recordedChunks = [];
    let isRecording = false;

    function toggleRecording(button) {
        if (!isRecording) {
            // å¼€å§‹å½•éŸ³
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    const mimeType = 'audio/webm';
                    mediaRecorder = new MediaRecorder(stream, { mimeType });
                    recordedChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        const blob = new Blob(recordedChunks, { type: mimeType });
                        convertToWavAndUpload(blob);
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    button.innerText = 'â¹ï¸ åœæ­¢å½•éŸ³';
                })
                .catch(err => {
                    console.error('è·å–éº¦å…‹é£å¤±è´¥:', err);
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™');
                });
        } else {
            // åœæ­¢å½•éŸ³
            mediaRecorder.stop();
            isRecording = false;
            button.innerText = 'ğŸ™ï¸ å½•éŸ³';
        }
    }

    function convertToWavAndUpload(webmBlob) {
        const reader = new FileReader();
        reader.onloadend = () => {
            const audioContext = new AudioContext({ sampleRate: 16000 });
            audioContext.decodeAudioData(reader.result)
                .then(buffer => {
                    const wavBlob = encodeWAV(buffer.getChannelData(0), 16000);
                    uploadWavBlob(wavBlob);
                });
        };
        reader.readAsArrayBuffer(webmBlob);
    }

    function encodeWAV(samples, sampleRate) {
        const buffer = new ArrayBuffer(44 + samples.length * 2);
        const view = new DataView(buffer);

        const writeString = (view, offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };

        const floatTo16BitPCM = (output, offset, input) => {
            for (let i = 0; i < input.length; i++, offset += 2) {
                let s = Math.max(-1, Math.min(1, input[i]));
                s = s < 0 ? s * 0x8000 : s * 0x7FFF;
                output.setInt16(offset, s, true);
            }
        };

        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + samples.length * 2, true);
        writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true); // fmt chunk size
        view.setUint16(20, 1, true); // Audio format (1 = PCM)
        view.setUint16(22, 1, true); // Channels
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * 2, true); // Byte rate
        view.setUint16(32, 2, true); // Block align
        view.setUint16(34, 16, true); // Bits per sample
        writeString(view, 36, 'data');
        view.setUint32(40, samples.length * 2, true);

        floatTo16BitPCM(view, 44, samples);
        return new Blob([view], { type: 'audio/wav' });
    }

    function uploadWavBlob(wavBlob) {
        const formData = new FormData();
        const room_id = checkUUID();
        const file = new File([wavBlob], "recording.wav", { type: "audio/wav" });
        formData.append('audio', file);
        formData.append('room_id', room_id);

        fetch('/api/upload_audio', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            console.log('éŸ³é¢‘ä¸Šä¼ æˆåŠŸ:', data);
            addChatMessage('ä¸Šä¼ ', 'å½•éŸ³éŸ³é¢‘ä¸Šä¼ æˆåŠŸ: ' + data.filename, 'server');
        })
        .catch(err => {
            console.error('ä¸Šä¼ å¤±è´¥:', err);
            alert('ä¸Šä¼ å¤±è´¥');
        });
    }
    </script>
</body>
</html>